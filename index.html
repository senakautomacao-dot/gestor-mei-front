<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor MEI - Painel</title>

  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --cor-primaria:#007bff;
      --cor-verde:#28a745;
      --cor-laranja:#fd7e14;
      --cor-vermelho:#dc3545;
      --bg:#f4f7f6;
      --text:#333;
      --card:#ffffff;
      --borda:#e0e0e0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
    }

    /* Sidebar */
    .sidebar{
      width:280px;
      background:var(--cor-primaria);
      color:white;
      padding:28px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{font-size:1.6rem;font-weight:700;text-align:center;margin-bottom:8px}
    .sidebar .btn{
      background:transparent;
      border:2px solid rgba(255,255,255,0.7);
      color:white;
      padding:12px 14px;
      border-radius:8px;
      text-align:left;
      cursor:pointer;
      font-weight:600;
      margin-bottom:10px;
    }
    .sidebar .btn:hover{background:rgba(255,255,255,0.08)}
    .sidebar .small{font-size:0.9rem;color:rgba(255,255,255,0.9)}
    .sidebar .footer{margin-top:auto;font-size:0.85rem;color:rgba(255,255,255,0.85)}

    /* Main content */
    .main{
      flex:1;
      padding:24px;
      overflow:auto;
    }
    header.app-header{
      background:linear-gradient(90deg,var(--cor-primaria),#0056b3);
      color:white;
      padding:18px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
    }
    header.app-header .left{display:flex;gap:12px;align-items:center}
    header.app-header h1{margin:0;font-size:1.25rem}
    header.app-header .actions{display:flex;gap:10px;align-items:center}

    /* Cards / sections */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:18px}
    .card{background:var(--card);padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    .card h3{margin:0 0 8px 0;color:var(--cor-primaria)}
    .big{font-size:1.5rem;font-weight:700}

    /* Forms */
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="tel"]{
      width:100%;padding:10px;border:1px solid var(--borda);border-radius:6px;margin-bottom:10px;
    }
    .btn-primary{
      background:var(--cor-primaria);color:white;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;
    }
    .btn-ghost{background:transparent;border:2px solid var(--cor-primaria);color:var(--cor-primaria);padding:8px 10px;border-radius:8px;cursor:pointer}

    /* History list */
    .history{max-height:320px;overflow:auto;border:1px solid #f0f0f0;border-radius:6px;padding:6px}
    .history .row{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #f7f7f7}
    .history .row:last-child{border-bottom:none}

    .hidden{display:none !important}
    .center{display:flex;align-items:center;justify-content:center}

    /* responsive */
    @media (max-width:1000px){
      .grid{grid-template-columns:repeat(1,1fr)}
      .sidebar{width:100%;flex-direction:row;gap:6px;align-items:center;padding:12px;overflow:auto}
      body{flex-direction:column}
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar hidden" id="sidebar">
    <div class="brand">Gestor MEI</div>
    <div id="user-block">
      <div class="small">Não autenticado</div>
    </div>

    <button class="btn" data-target="dashboard" onclick="showPage('dashboard')">Dashboard</button>
    <button class="btn" data-target="lancamentos" onclick="showPage('lancamentos')">Lançamentos</button>
    <button class="btn" data-target="historico" onclick="showPage('historico')">Histórico</button>
    <button class="btn" data-target="cnpj" onclick="showPage('cnpj')">Consulta CNPJ (BrasilAPI)</button>
    <button class="btn" data-target="acoes" onclick="showPage('acoes')">Ações Rápidas</button> (BrasilAPI)</button>

    <div style="height:10px"></div>
    <button id="btn-logout" class="btn hidden" style="background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25)" onclick="logout()">Sair</button>

    <div class="footer">Versão 1 • <small>Gestor MEI</small></div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="main">
    <header class="app-header">
      <div class="left">
        <h1>Painel do MEI</h1>
      </div>
      <div class="actions">
        <button id="btn-login" class="btn-primary">Entrar com Google</button>
      </div>
    </header>

    <!-- ====== LOGIN SCREEN (visível inicialmente) ====== -->
    <section id="login-screen" class="card">
      <h2>Bem-vindo ao Gestor MEI</h2>
      <p>Faça login com sua conta Google para continuar.</p>
      <div style="margin-top:14px">
        <button id="login-start" class="btn-primary">Entrar com Google</button>
      </div>
      <div id="login-info" style="margin-top:12px;color:#666;font-size:0.95rem">
        Após o login, você precisará fornecer seu CNPJ para verificar se é optante pelo MEI.
      </div>
    </section>

    <!-- ====== CNPJ CHECK (após login, obrigatório) ====== -->
    <section id="cnpj-screen" class="card hidden">
      <h3>Verificação obrigatória: informe seu CNPJ</h3>
      <p>O aplicativo é exclusivo para Microempreendedores Individuais (MEI).</p>
      <label for="cnpj-input">CNPJ (somente números)</label>
      <input id="cnpj-input" type="text" placeholder="00000000000191">
      <div style="display:flex;gap:10px">
        <button class="btn-primary" onclick="consultarCNPJ(true)">Consultar e validar</button>
        <button class="btn-ghost" onclick="skipCNPJ()">Cancelar (sair)</button>
      </div>
      <div id="cnpj-result" style="margin-top:16px"></div>
    </section>

    <!-- ====== APP AREA (escondida até CNPJ ser MEI) ====== -->
    <section id="app-area" class="hidden">
      <!-- Dashboard -->
      <section id="dashboard" class="card" style="display:block;">
        <div class="grid">
          <div class="card">
            <h3>Total Faturado</h3>
            <div class="big" id="total-receitas-display">R$ 0,00</div>
          </div>
          <div class="card">
            <h3>Total Compras</h3>
            <div class="big" id="total-compras-display">R$ 0,00</div>
          </div>
          <div class="card">
            <h3>Limite MEI (anual)</h3>
            <div class="big" id="limite-mei-display">R$ 81.000,00</div>
          </div>
        </div>

        <div class="card">
          <h3>Resumo Rápido</h3>
          <div id="resumo-rapido">Carregando...</div>
        </div>
      </section>

      <!-- Lançamentos -->
      <section id="lancamentos" class="card" style="display:none;margin-top:18px;">
        <h3>Adicionar Receita</h3>
        <label for="descricao-receita">Descrição</label>
        <input id="descricao-receita" type="text" placeholder="Ex: Venda do mês">
        <label for="valor-receita">Valor (R$)</label>
        <input id="valor-receita" type="number" step="0.01" placeholder="1500.00">
        <button class="btn-primary" onclick="adicionarReceita()">Adicionar Receita</button>

        <hr style="margin:18px 0">

        <h3>Adicionar Compra</h3>
        <label for="descricao-compra">Descrição</label>
        <input id="descricao-compra" type="text" placeholder="Ex: Compra de materiais">
        <label for="valor-compra">Valor (R$)</label>
        <input id="valor-compra" type="number" step="0.01" placeholder="200.00">
        <button class="btn-primary" onclick="adicionarCompra()">Adicionar Compra</button>
      </section>

      <!-- Histórico -->
      $&

      <!-- AÇÕES RÁPIDAS -->
      <section id="acoes" class="card" style="display:none;margin-top:18px;">
        <h3>Ações Rápidas</h3>
        <a href="https://www.nfse.gov.br/EmissorNacional/Login?ReturnUrl=%2fEmissorNacional" target="_blank" class="btn-primary" style="display:block;margin-bottom:10px;text-align:center;">Emitir Nota Fiscal (NFS-e)</a>
        <a href="https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/pgmei.app/Identificacao" target="_blank" class="btn-primary" style="background:#fd7e14;display:block;margin-bottom:10px;text-align:center;">Pagar Guia (DAS Mensal)</a>
        <a href="https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/dasnsimei.app/Identificacao" target="_blank" class="btn-primary" style="background:#343a40;display:block;margin-bottom:10px;text-align:center;">Entregar Declaração Anual</a>
        <button class="btn-primary" style="background:#17a2b8;text-align:center;" onclick="window.print()">Imprimir Relatório</button>
      </section>
    </section>

  </main>

  <script>
  /***** CONFIG - troque estes valores pelos seus reais *****/
  const SUPABASE_URL = "https://zrpxtooampraytmkywhl.supabase.co"; // substitua se necessário
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpycHh0b29hbXByYXl0bWt5d2hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzI4MTYsImV4cCI6MjA3ODYwODgxNn0.OHGbsF5njvJm6kfeGWeEwAR3Ewzk0JrTVwubiqWNa3g"; // <<== substituir pela sua ANON key pública
  const API_BASE = "https://gestor-mei-backend.onrender.com/api/"; // <<== substituir se necessário
  /*********************************************************/

  // cria cliente supabase (usar window.supabase para evitar shadowing/TDZ)
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // estado
  let session = null;
  let user = null;
  let receitas = [];
  let compras = [];

  // refs
  const sidebar = document.getElementById('sidebar');
  const btnLogin = document.getElementById('btn-login');
  const loginStart = document.getElementById('login-start');
  const btnLogout = document.getElementById('btn-logout');
  const userBlock = document.getElementById('user-block');

  // Inicialização: captura sessão (pode vir do redirect)
  (async function init(){
    try {
      const { data } = await supabaseClient.auth.getSession();
      session = data.session;
      user = session?.user ?? null;
    } catch(e){
      session = null; user = null;
    }
    // atualiza UI inicial
    updateAuthUI();

    // listener de auth (cuidado: redirecionamento também roda getSession)
    supabaseClient.auth.onAuthStateChange((event, s) => {
      session = s;
      user = s?.user ?? null;
      updateAuthUI();
      if(user){
        // após login, obrigamos a verificação de CNPJ
        showCNPJScreen();
      }
    });

    // Se já está logado, forçamos CNPJ screen
    if(user){
      showCNPJScreen();
    }
  })();

  // Atualiza UI de autenticação
  function updateAuthUI(){
    if(user){
      // o usuário está autenticado, mostrar email no sidebar quando liberado
      userBlock.innerHTML = `<div style="font-weight:700">${escapeHtml(user.email)}</div><div class="small">ID: ${escapeHtml(user.id)}</div>`;
      btnLogout.classList.remove('hidden');
      btnLogin.classList.add('hidden');
      loginStart.classList.add('hidden');
    } else {
      userBlock.innerHTML = `<div class="small">Não autenticado</div>`;
      btnLogout.classList.add('hidden');
      btnLogin.classList.remove('hidden');
      loginStart.classList.remove('hidden');
      // garantir que o app esteja no estado inicial (login)
      showOnlyLogin();
    }
  }

  // Login
  async function startLogin(){
    // usa redirecionamento (vai para Google e volta)
    const { error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.origin } // volta para a raiz
    });
    if(error) alert('Erro no login: ' + error.message);
  }
  loginStart.addEventListener('click', startLogin);
  btnLogin.addEventListener('click', startLogin);

  // logout
  async function logout(){
    try {
      await supabaseClient.auth.signOut();
    } catch(e){ console.warn('logout erro', e); }
    session = null; user = null;
    updateAuthUI();
    // voltar para estado inicial (login)
    window.location.href = window.location.origin;
  }

  // Forçar exibir só tela de login
  function showOnlyLogin(){
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('cnpj-screen').classList.add('hidden');
    document.getElementById('app-area').classList.add('hidden');
    sidebar.classList.add('hidden');
  }

  // Mostrar tela de CNPJ após login
  function showCNPJScreen(){
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('cnpj-screen').classList.remove('hidden');
    document.getElementById('app-area').classList.add('hidden');
    sidebar.classList.add('hidden'); // sidebar ficará escondido até liberação
    // limpa resultado anterior
    document.getElementById('cnpj-result').innerText = '';
    document.getElementById('cnpj-input').value = '';
  }

  // Quando CNPJ validado como MEI -> libera app
  function unlockApp(cnpjData){
    // mostra sidebar e app
    document.getElementById('cnpj-screen').classList.add('hidden');
    document.getElementById('app-area').classList.remove('hidden');
    sidebar.classList.remove('hidden');
    // exibir dashboard por padrão
    showPage('dashboard');
    // atualizar UI com info já carregada
    carregarDadosIniciais();
  }

  // quando clica cancelar na tela de cnpj
  function skipCNPJ(){
    // optou por sair — desloga
    logout();
  }

  // Valida se resposta BrasilAPI indica MEI (defensivo)
  function isMEIFromBrasilAPI(data){
    if(!data) return false;
    // várias maneiras que podem indicar MEI:
    try {
      // 1) objeto simples/simples_mei
      if(data.simples && (data.simples.simples_mei === true || data.simples_simples === true)) return true;
      // 2) campos com texto MEI
      if(/MEI/i.test(String(data.tipo || '') ) ) return true;
      if(/MEI/i.test(String(data.natureza_juridica || '') ) ) return true;
      // 3) porte or description
      if(/microempreendedor|microempreended/i.test(String(data.natureza_juridica || '') ) ) return true;
      // 4) some APIs return 'opcao_simples' or 'enti' - check atividade_principal text?
      if(data.atividade_principal && Array.isArray(data.atividade_principal)){
        const txt = (data.atividade_principal[0].text || '') + '';
        if(/MEI/i.test(txt)) return true;
      }
    } catch(e){}
    return false;
  }

  // Consulta CNPJ e valida, com opção de forcar logout automatico caso não seja MEI
  async function consultarCNPJ(doLogoutIfNotMEI = true){
    const out = document.getElementById('cnpj-result');
    const raw = document.getElementById('cnpj-input').value || '';
    const cnpj = raw.replace(/\D/g,'');
    out.innerHTML = 'Buscando...';
    if(!cnpj || cnpj.length !== 14){
      out.innerHTML = '<span style="color:#a00">CNPJ inválido — informe 14 dígitos.</span>';
      return;
    }
    try {
      const res = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
      if(!res.ok){
        out.innerHTML = '<span style="color:#a00">Não encontrado / API indisponível</span>';
        return;
      }
      const data = await res.json();
      // mostrar resumo
      out.innerHTML = `
        <strong>${escapeHtml(data.nome || data.fantasia || '')}</strong><br/>
        CNPJ: ${escapeHtml(data.cnpj || cnpj)} • Situação: ${escapeHtml(data.situacao || data.estagio || '')}<br/>
        Abertura: ${escapeHtml(data.data_situacao || data.abertura || '')}<br/>
        Atividade Principal: ${escapeHtml((data.atividade_principal && data.atividade_principal[0] && data.atividade_principal[0].text) || '')}
      `;

      // validar MEI
      const isMei = isMEIFromBrasilAPI(data);
      if(isMei){
        // liberado
        out.innerHTML += `<div style="margin-top:10px;color:var(--cor-verde);font-weight:700">CNPJ validado como MEI — acesso liberado.</div>`;
        // desbloquear app
        unlockApp(data);
      } else {
        // não é MEI -> mostra mensagem e desloga (opção B)
        out.innerHTML += `<div style="margin-top:10px;color:var(--cor-vermelho);font-weight:700">Este CNPJ não está registrado como MEI. O app é só para MEI.</div>`;
        if(doLogoutIfNotMEI){
          setTimeout(async ()=> {
            alert('Seu CNPJ não é MEI. Você será desconectado.');
            await logout();
          }, 1200);
        }
      }

    } catch(e){
      console.error('ERR CNPJ', e);
      out.innerHTML = '<span style="color:#a00">Erro na consulta: ' + escapeHtml(e.message||e) + '</span>';
    }
  }

  // ================= BACKEND INTEGRAÇÃO =================
  async function apiFetch(path, method='GET', body=null){
    if(!session || !session.access_token) throw new Error('Usuário sem sessão');
    const headers = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + session.access_token
    };
    const res = await fetch(API_BASE + path, {
      method,
      headers,
      body: body ? JSON.stringify(body) : null,
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(`API ${res.status}: ${txt}`);
    }
    return res.json();
  }

  // carregar receitas/compras e dashboard quando liberado
  async function carregarDadosIniciais(){
    try {
      // atualizar session por precaução
      const s = await supabaseClient.auth.getSession();
      session = s.data.session;
      user = session?.user ?? null;
    } catch(e){}
    // carregar dados do backend
    try {
      receitas = await apiFetch('receitas/');
    } catch(e){ receitas = []; console.warn('erro receitas', e); }
    try {
      compras = await apiFetch('compras/');
    } catch(e){ compras = []; console.warn('erro compras', e); }

    atualizarDashboard();
    renderHistory();
  }

  // adicionar receita
  async function adicionarReceita(){
    try {
      const descricao = document.getElementById('descricao-receita').value.trim();
      const valor = parseFloat(document.getElementById('valor-receita').value);
      if(!descricao || !valor) return alert('Descrição e valor válidos');
      const res = await apiFetch('add-receita/','POST',{descricao,valor});
      if(res && res.data){
        const inserted = Array.isArray(res.data) ? res.data[0] : res.data;
        receitas.unshift(inserted);
      } else {
        await carregarDadosIniciais();
      }
      document.getElementById('descricao-receita').value='';
      document.getElementById('valor-receita').value='';
      atualizarDashboard();
      renderHistory();
    } catch(err){
      console.error(err);
      alert('Erro ao adicionar receita: ' + (err.message || err));
    }
  }

  async function adicionarCompra(){
    try {
      const descricao = document.getElementById('descricao-compra').value.trim();
      const valor = parseFloat(document.getElementById('valor-compra').value);
      if(!descricao || !valor) return alert('Descrição e valor válidos');
      const res = await apiFetch('add-compra/','POST',{descricao,valor});
      if(res && res.data){
        const inserted = Array.isArray(res.data) ? res.data[0] : res.data;
        compras.unshift(inserted);
      } else {
        await carregarDadosIniciais();
      }
      document.getElementById('descricao-compra').value='';
      document.getElementById('valor-compra').value='';
      atualizarDashboard();
      renderHistory();
    } catch(err){
      console.error(err);
      alert('Erro ao adicionar compra: ' + (err.message || err));
    }
  }

  // dashboard update
  function atualizarDashboard(){
    const somaReceitas = receitas.reduce((s,r)=>s + (Number(r.valor)||0), 0);
    const somaCompras = compras.reduce((s,c)=>s + (Number(c.valor)||0), 0);
    document.getElementById('total-receitas-display').innerText = formatBRL(somaReceitas);
    document.getElementById('total-compras-display').innerText = formatBRL(somaCompras);
    const restante = 81000 - somaReceitas;
    document.getElementById('resumo-rapido').innerText =
      `Receitas: ${formatBRL(somaReceitas)} • Compras: ${formatBRL(somaCompras)} • Limite restante: ${formatBRL(restante)}`;
  }

  // history render
  function renderHistory(){
    const filtro = document.getElementById('filtro-tipo').value;
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    let items = [];
    if(filtro==='all' || filtro==='receitas'){
      receitas.forEach(r=> items.push({type:'receita', descricao:r.descricao, valor:r.valor, created_at:r.created_at}));
    }
    if(filtro==='all' || filtro==='compras'){
      compras.forEach(c=> items.push({type:'compra', descricao:c.descricao, valor:c.valor, created_at:c.created_at}));
    }
    if(items.length===0){
      list.innerHTML = "<div class='row'><div>Nenhum lançamento.</div></div>";
      return;
    }
    items.sort((a,b)=> (b.created_at||0) - (a.created_at||0));
    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'row';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${it.type==='receita'?'Receita':'Compra'}</strong><div>${escapeHtml(it.descricao)}</div>`;
      const right = document.createElement('div');
      right.innerHTML = `<div style="text-align:right">${formatBRL(it.valor)}</div>`;
      row.appendChild(left); row.appendChild(right);
      list.appendChild(row);
    });
  }

  document.getElementById('filtro-tipo').addEventListener('change', renderHistory);

  // navigation (sidebar)
  function showPage(page){
    const pages = ['dashboard','lancamentos','historico','cnpj'];
    pages.forEach(p => {
      const el = document.getElementById(p);
      if(el) el.style.display = (p===page)?'block':'none';
    });
    // highlight
    document.querySelectorAll('.sidebar .btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.target===page);
    });
  }

  // helpers
  function formatBRL(v){ return Number(v || 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  // small UX
  document.getElementById('valor-receita').addEventListener('keydown', e=>{ if(e.key==='Enter') adicionarReceita(); });
  document.getElementById('valor-compra').addEventListener('keydown', e=>{ if(e.key==='Enter') adicionarCompra(); });
  document.getElementById('cnpj-input').addEventListener('keydown', e=>{ if(e.key==='Enter') consultarCNPJ(true); });

  // initial view default
  showOnlyLogin();

  </script>
</body>
</html>
