<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor MEI - Painel</title>

  <!-- CSS profissional (sidebar + conteúdo) -->
  <style>
    :root{
      --cor-primaria:#007bff;
      --cor-verde:#28a745;
      --cor-laranja:#fd7e14;
      --cor-vermelho:#dc3545;
      --bg:#f4f7f6;
      --text:#333;
      --card:#ffffff;
      --borda:#e0e0e0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
    }

    /* Sidebar */
    .sidebar{
      width:280px;
      background:var(--cor-primaria);
      color:white;
      padding:28px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{font-size:1.6rem;font-weight:700;text-align:center;margin-bottom:8px}
    .sidebar .btn{
      background:transparent;
      border:2px solid rgba(255,255,255,0.7);
      color:white;
      padding:12px 14px;
      border-radius:8px;
      text-align:left;
      cursor:pointer;
      font-weight:600;
      margin-bottom:10px;
    }
    .sidebar .btn:hover{background:rgba(255,255,255,0.08)}
    .sidebar .small{font-size:0.9rem;color:rgba(255,255,255,0.9)}
    .sidebar .footer{margin-top:auto;font-size:0.85rem;color:rgba(255,255,255,0.85)}

    /* Main content */
    .main{
      flex:1;
      padding:24px;
      overflow:auto;
    }
    header.app-header{
      background:linear-gradient(90deg,var(--cor-primaria),#0056b3);
      color:white;
      padding:18px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
    }
    header.app-header .left{display:flex;gap:12px;align-items:center}
    header.app-header h1{margin:0;font-size:1.25rem}
    header.app-header .actions{display:flex;gap:10px;align-items:center}

    /* Cards / sections */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:18px}
    .card{background:var(--card);padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    .card h3{margin:0 0 8px 0;color:var(--cor-primaria)}
    .big{font-size:1.5rem;font-weight:700}

    /* Forms */
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="tel"]{
      width:100%;padding:10px;border:1px solid var(--borda);border-radius:6px;margin-bottom:10px;
    }
    .btn-primary{
      background:var(--cor-primaria);color:white;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;
    }
    .btn-ghost{background:transparent;border:2px solid var(--cor-primaria);color:var(--cor-primaria);padding:8px 10px;border-radius:8px;cursor:pointer}

    /* History list */
    .history{max-height:320px;overflow:auto;border:1px solid #f0f0f0;border-radius:6px;padding:6px}
    .history .row{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #f7f7f7}
    .history .row:last-child{border-bottom:none}

    /* responsive */
    @media (max-width:1000px){
      .grid{grid-template-columns:repeat(1,1fr)}
      .sidebar{width:100%;flex-direction:row;gap:6px;align-items:center;padding:12px;overflow:auto}
      body{flex-direction:column}
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Gestor MEI</div>
    <div id="user-block">
      <div class="small">Não autenticado</div>
    </div>

    <button class="btn" data-target="dashboard" onclick="showPage('dashboard')">Dashboard</button>
    <button class="btn" data-target="lancamentos" onclick="showPage('lancamentos')">Lançamentos</button>
    <button class="btn" data-target="historico" onclick="showPage('historico')">Histórico</button>
    <button class="btn" data-target="cnpj" onclick="showPage('cnpj')">Consulta CNPJ (BrasilAPI)</button>

    <div style="height:10px"></div>
    <button id="btn-logout" class="btn" style="display:none;background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25)" onclick="logout()">Sair</button>

    <div class="footer">Versão 1 • <small>Gestor MEI</small></div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="app-header">
      <div class="left">
        <h1>Painel do MEI</h1>
      </div>
      <div class="actions">
        <button id="btn-login" class="btn-primary">Entrar com Google</button>
      </div>
    </header>

    <!-- DASHBOARD -->
    <section id="dashboard" class="card" style="display:none;">
      <div class="grid">
        <div class="card">
          <h3>Total Faturado</h3>
          <div class="big" id="total-receitas-display">R$ 0,00</div>
        </div>
        <div class="card">
          <h3>Total Compras</h3>
          <div class="big" id="total-compras-display">R$ 0,00</div>
        </div>
        <div class="card">
          <h3>Limite MEI (anual)</h3>
          <div class="big" id="limite-mei-display">R$ 81.000,00</div>
        </div>
      </div>

      <div class="card">
        <h3>Resumo Rápido</h3>
        <div id="resumo-rapido">Carregando...</div>
      </div>
    </section>

    <!-- LANÇAMENTOS -->
    <section id="lancamentos" class="card" style="display:none;">
      <h3>Adicionar Receita</h3>
      <label for="descricao-receita">Descrição</label>
      <input id="descricao-receita" type="text" placeholder="Ex: Venda do mês">
      <label for="valor-receita">Valor (R$)</label>
      <input id="valor-receita" type="number" step="0.01" placeholder="1500.00">
      <button class="btn-primary" onclick="adicionarReceita()">Adicionar Receita</button>

      <hr style="margin:18px 0">

      <h3>Adicionar Compra</h3>
      <label for="descricao-compra">Descrição</label>
      <input id="descricao-compra" type="text" placeholder="Ex: Compra de materiais">
      <label for="valor-compra">Valor (R$)</label>
      <input id="valor-compra" type="number" step="0.01" placeholder="200.00">
      <button class="btn-primary" onclick="adicionarCompra()">Adicionar Compra</button>
    </section>

    <!-- HISTÓRICO -->
    <section id="historico" class="card" style="display:none;">
      <h3>Histórico</h3>
      <div style="display:flex;gap:10px;margin-bottom:10px">
        <div style="flex:1">
          <label>Filtrar por</label>
          <select id="filtro-tipo">
            <option value="all">Todos</option>
            <option value="receitas">Receitas</option>
            <option value="compras">Compras</option>
          </select>
        </div>
      </div>

      <div class="history" id="history-list">
        <div class="row"><div>Nenhum lançamento.</div></div>
      </div>
    </section>

    <!-- CNPJ -->
    <section id="cnpj" class="card" style="display:none;">
      <h3>Consulta CNPJ (BrasilAPI)</h3>
      <label for="cnpj-input">CNPJ (somente números)</label>
      <input id="cnpj-input" type="text" placeholder="00000000000191">
      <button class="btn-primary" onclick="consultarCNPJ()">Consultar</button>

      <div id="cnpj-result" style="margin-top:16px"></div>
    </section>
  </main>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- SCRIPT: lógica, autenticação, chamadas API e BrasilAPI -->
  <script>
  /***** CONFIG - troque estes valores pelos seus reais *****/
  const SUPABASE_URL = "https://zrpxtooampraytmkywhl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpycHh0b29hbXByYXl0bWt5d2hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzI4MTYsImV4cCI6MjA3ODYwODgxNn0.OHGbsF5njvJm6kfeGWeEwAR3Ewzk0JrTVwubiqWNa3g"; // <<== substituir
  const API_BASE = "https://gestor-mei-backend.onrender.com/api/"; // <<== substituir se for outro
  /*********************************************************/

  const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Estado
  let session = null;
  let user = null;
  let receitas = [];
  let compras = [];

  // UI refs
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  const userBlock = document.getElementById('user-block');

  // Inicializa: verifica sessão existente
  (async function init(){
    const { data } = await supabase.auth.getSession();
    session = data.session;
    user = session?.user ?? null;
    updateAuthUI();

    // escuta mudanças de auth
    supabase.auth.onAuthStateChange((event, s) => {
      session = s;
      user = s?.user ?? null;
      updateAuthUI();
      if(user) loadAll();
    });
  })();

  // atualiza UI auth
  function updateAuthUI(){
    if(user){
      btnLogin.style.display = 'none';
      btnLogout.style.display = 'block';
      userBlock.innerHTML = `<div style="font-weight:700">${user.email}</div><div class="small">ID: ${user.id}</div>`;
      showPage('dashboard');
      loadAll();
    } else {
      btnLogin.style.display = 'block';
      btnLogout.style.display = 'none';
      userBlock.innerHTML = `<div class="small">Não autenticado</div>`;
      showPage('dashboard'); // mostrar instruções; usuário deve logar
    }
  }

  // loginWithGoogle
  btnLogin.addEventListener('click', async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.href }
    });
    if(error) alert("Erro login: " + error.message);
  });

  // logout
  async function logout(){
    await supabase.auth.signOut();
    session = null; user = null;
    updateAuthUI();
    window.location.reload();
  }

  // Paginação / navegação
  function showPage(page){
    const pages = ['dashboard','lancamentos','historico','cnpj'];
    pages.forEach(p => {
      const el = document.getElementById(p);
      if(el) el.style.display = (p===page)?'block':'none';
    });
    // destacar botão no sidebar
    document.querySelectorAll('.sidebar .btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.target===page);
    });
  }

  // Função utilitária para chamadas ao backend (com token)
  async function apiFetch(path, method='GET', body=null){
    if(!user || !session) throw new Error('Usuário não autenticado');
    const headers = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + session.access_token
    };
    const res = await fetch(API_BASE + path, {
      method,
      headers,
      body: body ? JSON.stringify(body) : null,
    });
    if(!res.ok){
      const text = await res.text();
      throw new Error(`API ${res.status}: ${text}`);
    }
    return res.json();
  }

  // Carrega receitas e compras e dashboard
  async function loadAll(){
    try {
      receitas = await apiFetch('receitas/'); // retorna array
    } catch(e){
      console.error('Erro carregar receitas:', e);
      receitas = [];
    }
    try {
      compras = await apiFetch('compras/'); // retorna array
    } catch(e){
      console.error('Erro carregar compras:', e);
      compras = [];
    }
    atualizarDashboard();
    renderHistory();
  }

  // Adicionar receita
  async function adicionarReceita(){
    try {
      const descricao = document.getElementById('descricao-receita').value.trim();
      const valor = parseFloat(document.getElementById('valor-receita').value);
      if(!descricao || !valor) return alert('Descrição e valor válidos');
      const res = await apiFetch('add-receita/','POST',{descricao,valor});
      // backend retorna {success:true,data: [...]}
      if(res && res.data){
        // insere local
        const inserted = Array.isArray(res.data) ? res.data[0] : res.data;
        receitas.unshift(inserted);
      } else {
        // caso o backend retorne forma diferente
        await loadAll();
      }
      document.getElementById('descricao-receita').value='';
      document.getElementById('valor-receita').value='';
      atualizarDashboard();
      renderHistory();
    } catch(err){
      console.error(err);
      alert('Erro ao adicionar receita: ' + err.message);
    }
  }

  // Adicionar compra
  async function adicionarCompra(){
    try {
      const descricao = document.getElementById('descricao-compra').value.trim();
      const valor = parseFloat(document.getElementById('valor-compra').value);
      if(!descricao || !valor) return alert('Descrição e valor válidos');
      const res = await apiFetch('add-compra/','POST',{descricao,valor});
      if(res && res.data){
        const inserted = Array.isArray(res.data) ? res.data[0] : res.data;
        compras.unshift(inserted);
      } else {
        await loadAll();
      }
      document.getElementById('descricao-compra').value='';
      document.getElementById('valor-compra').value='';
      atualizarDashboard();
      renderHistory();
    } catch(err){
      console.error(err);
      alert('Erro ao adicionar compra: ' + err.message);
    }
  }

  // Atualiza dashboard
  function atualizarDashboard(){
    const somaReceitas = receitas.reduce((s,r)=>s + (Number(r.valor)||0), 0);
    const somaCompras = compras.reduce((s,c)=>s + (Number(c.valor)||0), 0);
    document.getElementById('total-receitas-display').innerText = formatBRL(somaReceitas);
    document.getElementById('total-compras-display').innerText = formatBRL(somaCompras);
    // resumo
    const restante = 81000 - somaReceitas;
    document.getElementById('resumo-rapido').innerText =
      `Receitas: ${formatBRL(somaReceitas)} • Compras: ${formatBRL(somaCompras)} • Limite restante: ${formatBRL(restante)}`;
  }

  // Renderiza histórico
  function renderHistory(){
    const filtro = document.getElementById('filtro-tipo').value;
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    let items = [];
    if(filtro==='all' || filtro==='receitas'){
      receitas.forEach(r=> items.push({type:'receita', descricao:r.descricao, valor:r.valor, created_at:r.created_at}));
    }
    if(filtro==='all' || filtro==='compras'){
      compras.forEach(c=> items.push({type:'compra', descricao:c.descricao, valor:c.valor, created_at:c.created_at}));
    }
    if(items.length===0){
      list.innerHTML = "<div class='row'><div>Nenhum lançamento.</div></div>";
      return;
    }
    // ordenar por created_at desc se existir
    items.sort((a,b)=> (b.created_at||0) - (a.created_at||0));
    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'row';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${it.type==='receita'?'Receita':'Compra'}</strong><div>${escapeHtml(it.descricao)}</div>`;
      const right = document.createElement('div');
      right.innerHTML = `<div style="text-align:right">${formatBRL(it.valor)}</div>`;
      row.appendChild(left); row.appendChild(right);
      list.appendChild(row);
    });
  }

  document.getElementById('filtro-tipo').addEventListener('change', renderHistory);

  // CONSULTA CNPJ via BrasilAPI
  async function consultarCNPJ(){
    const cnpj = document.getElementById('cnpj-input').value.replace(/\D/g,'');
    const out = document.getElementById('cnpj-result');
    out.innerHTML = 'Buscando...';
    if(!cnpj || cnpj.length!==14){ out.innerHTML='CNPJ inválido (14 dígitos)'; return; }
    try {
      const res = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
      if(!res.ok){
        out.innerHTML = 'Não encontrado / API indisponível';
        return;
      }
      const data = await res.json();
      // Exibe nome, situação, abertura, atividade principal
      out.innerHTML = `
        <strong>${escapeHtml(data.nome)}</strong><br>
        CNPJ: ${escapeHtml(data.cnpj)} • Situação: ${escapeHtml(data.estagio || data.situacao)}<br>
        Abertura: ${escapeHtml(data.data_situacao || data.abertura)}<br>
        Atividade Principal: ${escapeHtml((data.atividade_principal && data.atividade_principal[0] && data.atividade_principal[0].text) || '')}
      `;
    } catch(e){
      console.error(e);
      out.innerHTML = 'Erro na consulta: ' + e.message;
    }
  }

  // Helpers
  function formatBRL(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  // small UX: allow Enter on inputs
  document.getElementById('valor-receita').addEventListener('keydown', e=>{ if(e.key==='Enter') adicionarReceita(); });
  document.getElementById('valor-compra').addEventListener('keydown', e=>{ if(e.key==='Enter') adicionarCompra(); });
  document.getElementById('cnpj-input').addEventListener('keydown', e=>{ if(e.key==='Enter') consultarCNPJ(); });

  // initial page
  showPage('dashboard');

  </script>
</body>
</html>
