<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor MEI - Painel</title>

  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --cor-primaria:#007bff;
      --cor-verde:#28a745;
      --cor-laranja:#fd7e14;
      --cor-vermelho:#dc3545;
      --bg:#f4f7f6;
      --text:#333;
      --card:#ffffff;
      --borda:#e0e0e0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
    }

    /* Sidebar */
    .sidebar{
      width:280px;
      background:var(--cor-primaria);
      color:white;
      padding:28px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{font-size:1.6rem;font-weight:700;text-align:center;margin-bottom:8px}
    .sidebar .btn{
      background:transparent;
      border:2px solid rgba(255,255,255,0.7);
      color:white;
      padding:12px 14px;
      border-radius:8px;
      text-align:left;
      cursor:pointer;
      font-weight:600;
      margin-bottom:10px;
    }
    .sidebar .btn:hover{background:rgba(255,255,255,0.08)}
    .sidebar .small{font-size:0.9rem;color:rgba(255,255,255,0.9)}
    .sidebar .footer{margin-top:auto;font-size:0.85rem;color:rgba(255,255,255,0.85)}

    /* Main */
    .main{
      flex:1;
      padding:24px;
      overflow:auto;
    }

    header.app-header{
      background:linear-gradient(90deg,var(--cor-primaria),#0056b3);
      color:white;
      padding:18px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
    }
    header.app-header h1{
      margin:0;font-size:1.25rem
    }

    .card{
      background:var(--card);
      padding:16px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.04)
    }

    .hidden{display:none!important}
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar hidden" id="sidebar">
    <div class="brand">Gestor MEI</div>
    <div id="user-block">
      <div class="small">Não autenticado</div>
    </div>

    <button class="btn" data-target="dashboard" onclick="showPage('dashboard')">Dashboard</button>
    <button class="btn" data-target="lancamentos" onclick="showPage('lancamentos')">Lançamentos</button>
    <button class="btn" data-target="historico" onclick="showPage('historico')">Histórico</button>
    <button class="btn" data-target="cnpj" onclick="showPage('cnpj')">Consulta CNPJ (BrasilAPI)</button>
    <button class="btn" data-target="acoes" onclick="showPage('acoes')">Ações Rápidas</button>

    <div style="height:10px"></div>
    <button id="btn-logout" class="btn hidden" style="background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25)" onclick="logout()">Sair</button>

    <div class="footer">Versão 1 • <small>Gestor MEI</small></div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="main">
    <header class="app-header">
      <h1>Painel do MEI</h1>
      <button id="btn-login" class="btn-primary">Entrar com Google</button>
    </header>

    <!-- TELA LOGIN -->
    <section id="login-screen" class="card">
      <h2>Bem-vindo ao Gestor MEI</h2>
      <p>Faça login com sua conta Google para continuar.</p>
      <button id="login-start" class="btn-primary">Entrar com Google</button>
    </section>

    <!-- TELA CNPJ -->
    <section id="cnpj-screen" class="card hidden">
      <h3>Verificação obrigatória: informe seu CNPJ</h3>
      <p>O aplicativo é exclusivo para Microempreendedores Individuais (MEI).</p>

      <label for="cnpj-input">CNPJ (somente números)</label>
      <input id="cnpj-input" type="text" placeholder="00000000000191">

      <div style="display:flex;gap:10px">
        <button class="btn-primary" onclick="consultarCNPJ(true)">Consultar e validar</button>
        <button class="btn-ghost" onclick="skipCNPJ()">Cancelar (sair)</button>
      </div>

      <div id="cnpj-result" style="margin-top:16px"></div>
    </section>


    <!-- ÁREA PRINCIPAL DO APP (liberada somente após validar MEI) -->
    <section id="app-area" class="hidden">

      <!-- DASHBOARD -->
      <section id="dashboard" class="card" style="display:block;">
        <h3>Dashboard</h3>

        <div class="grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:18px">
          <div class="card">
            <h3>Total Faturado</h3>
            <div class="big" id="total-receitas-display">R$ 0,00</div>
          </div>
          <div class="card">
            <h3>Total Compras</h3>
            <div class="big" id="total-compras-display">R$ 0,00</div>
          </div>
          <div class="card">
            <h3>Limite MEI (anual)</h3>
            <div class="big" id="limite-mei-display">R$ 81.000,00</div>
          </div>
        </div>

        <div class="card">
          <h3>Resumo Rápido</h3>
          <div id="resumo-rapido">Carregando...</div>
        </div>
      </section>


      <!-- LANÇAMENTOS -->
      <section id="lancamentos" class="card" style="display:none;margin-top:18px;">
        <h3>Adicionar Receita</h3>
        <label for="descricao-receita">Descrição</label>
        <input id="descricao-receita" type="text" placeholder="Ex: Venda do mês">

        <label for="valor-receita">Valor (R$)</label>
        <input id="valor-receita" type="number" step="0.01" placeholder="1500.00">

        <button class="btn-primary" onclick="adicionarReceita()">Adicionar Receita</button>

        <hr style="margin:18px 0">

        <h3>Adicionar Compra</h3>
        <label for="descricao-compra">Descrição</label>
        <input id="descricao-compra" type="text" placeholder="Ex: Compra de materiais">

        <label for="valor-compra">Valor (R$)</label>
        <input id="valor-compra" type="number" step="0.01" placeholder="200.00">

        <button class="btn-primary" onclick="adicionarCompra()">Adicionar Compra</button>
      </section>


      <!-- HISTÓRICO -->
      <section id="historico" class="card" style="display:none;margin-top:18px;">
        <h3>Histórico</h3>

        <div style="display:flex;gap:10px;margin-bottom:10px">
          <div style="flex:1">
            <label>Filtrar por</label>
            <select id="filtro-tipo">
              <option value="all">Todos</option>
              <option value="receitas">Receitas</option>
              <option value="compras">Compras</option>
            </select>
          </div>
        </div>

        <div class="history" id="history-list" style="max-height:320px;overflow:auto;border:1px solid #f0f0f0;border-radius:6px;padding:6px">
          <div class="row"><div>Nenhum lançamento.</div></div>
        </div>
      </section>


      <!-- AÇÕES RÁPIDAS -->
      <section id="acoes" class="card" style="display:none;margin-top:18px;">
        <h3>Ações Rápidas</h3>

        <a href="https://www.nfse.gov.br/EmissorNacional/Login?ReturnUrl=%2fEmissorNacional"
           target="_blank"
           class="btn-primary"
           style="display:block;margin-bottom:10px;text-align:center;">
           Emitir Nota Fiscal (NFS-e)
        </a>

        <a href="https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/pgmei.app/Identificacao"
           target="_blank"
           class="btn-primary"
           style="background:#fd7e14;display:block;margin-bottom:10px;text-align:center;">
           Pagar Guia (DAS Mensal)
        </a>

        <a href="https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/dasnsimei.app/Identificacao"
           target="_blank"
           class="btn-primary"
           style="background:#343a40;display:block;margin-bottom:10px;text-align:center;">
           Entregar Declaração Anual
        </a>

        <button class="btn-primary"
                style="background:#17a2b8;text-align:center;"
                onclick="window.print()">
          Imprimir Relatório
        </button>
      </section>

    </section> <!-- fim app-area -->
  </main>

<script>
/***** CONFIG SUA ***** */
const SUPABASE_URL = "https://zrpxtooampraytmkywhl.supabase.co";  
const SUPABASE_ANON_KEY = "SUA_ANON_KEY_AQUI"; 
const API_BASE = "https://gestor-mei-backend.onrender.com/api/";
/*******************************************************/

/* Inicializar Supabase Corretamente */
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Estados globais */
let session = null;
let user = null;
let receitas = [];
let compras = [];

/* Referências */
const sidebar = document.getElementById('sidebar');
const btnLogin = document.getElementById('btn-login');
const loginStart = document.getElementById('login-start');
const btnLogout = document.getElementById('btn-logout');
const userBlock = document.getElementById('user-block');

/* ---- INICIALIZAÇÃO ---- */
(async function init(){
  const { data } = await supabaseClient.auth.getSession();
  session = data.session;
  user = session?.user ?? null;

  updateAuthUI();

  supabaseClient.auth.onAuthStateChange((event, s) => {
    session = s;
    user = s?.user ?? null;
    updateAuthUI();
    if (user) showCNPJScreen();
  });

  if (user) showCNPJScreen();
})();

/* ---- UI DE AUTENTICAÇÃO ---- */
function updateAuthUI(){
  if (user){
    userBlock.innerHTML = `
      <div style="font-weight:700">${escapeHtml(user.email)}</div>
      <div class="small">ID: ${escapeHtml(user.id)}</div>
    `;
    btnLogout.classList.remove("hidden");
    btnLogin.classList.add("hidden");
    loginStart.classList.add("hidden");
  } else {
    userBlock.innerHTML = `<div class="small">Não autenticado</div>`;
    btnLogout.classList.add("hidden");
    btnLogin.classList.remove("hidden");
    loginStart.classList.remove("hidden");
    showOnlyLogin();
  }
}

/* ---- LOGIN ---- */
async function startLogin(){
  const { error } = await supabaseClient.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.origin }
  });
  if (error) alert("Erro no login: " + error.message);
}
btnLogin.addEventListener('click', startLogin);
loginStart.addEventListener('click', startLogin);

/* ---- LOGOUT ---- */
async function logout(){
  await supabaseClient.auth.signOut();
  session = null;
  user = null;
  updateAuthUI();
  window.location.href = window.location.origin;
}

/* ---- TELAS ---- */
function showOnlyLogin(){
  document.getElementById("login-screen").classList.remove("hidden");
  document.getElementById("cnpj-screen").classList.add("hidden");
  document.getElementById("app-area").classList.add("hidden");
  sidebar.classList.add("hidden");
}

function showCNPJScreen(){
  document.getElementById("login-screen").classList.add("hidden");
  document.getElementById("cnpj-screen").classList.remove("hidden");
  document.getElementById("app-area").classList.add("hidden");
  sidebar.classList.add("hidden");
  document.getElementById("cnpj-result").innerHTML = "";
  document.getElementById("cnpj-input").value = "";
}

/* ---- VALIDAÇÃO DE MEI (CORRETA) ---- */
function isMEI(data){
  if (!data) return false;

  if (data.opcao_pelo_mei === true) return true;
  if (data.simples?.opcao_mei === true) return true;
  if (data.simples?.simples_mei === true) return true;

  return false;
}

/* ---- CONSULTA CNPJ ---- */
async function consultarCNPJ(doLogoutIfNotMEI=true){
  const out = document.getElementById('cnpj-result');
  const cnpj = document.getElementById('cnpj-input').value.replace(/\D/g, '');

  if (cnpj.length !== 14){
    out.innerHTML = "<span style='color:#a00'>CNPJ inválido.</span>";
    return;
  }

  out.innerHTML = "Buscando...";

  try {
    const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
    if (!response.ok){
      out.innerHTML = "<span style='color:#a00'>Erro na API.</span>";
      return;
    }

    const data = await response.json();
    const mei = isMEI(data);

    out.innerHTML = `
      <strong>${escapeHtml(data.nome || data.razao_social || "")}</strong><br>
      Situação: ${data.situacao || "N/D"}<br>
      Abertura: ${data.data_abertura || data.data_inicio_atividade || ""}
    `;

    if (mei){
      out.innerHTML += `<div style="color:var(--cor-verde);font-weight:700;margin-top:8px;">CNPJ validado como MEI. Acesso liberado!</div>`;
      unlockApp();
    } else {
      out.innerHTML += `<div style="color:var(--cor-vermelho);font-weight:700;margin-top:8px;">Este CNPJ NÃO é MEI.</div>`;
      if(doLogoutIfNotMEI){
        setTimeout(() => logout(), 1200);
      }
    }
  } catch (err) {
    out.innerHTML = "<span style='color:#a00'>Erro inesperado.</span>";
  }
}

function skipCNPJ(){ logout(); }

/* ---- DESBLOQUEIA A ÁREA DO APP ---- */
function unlockApp(){
  document.getElementById("cnpj-screen").classList.add("hidden");
  document.getElementById("app-area").classList.remove("hidden");
  sidebar.classList.remove("hidden");
  showPage("dashboard");
  carregarDadosIniciais();
}

/* ---- HELPER ---- */
function escapeHtml(txt){
  if (!txt) return "";
  return txt.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ---- API DO BACKEND ---- */
async function apiFetch(path, method="GET", body=null){
  if (!session?.access_token) throw new Error("Usuário sem sessão");
  const headers = {
    "Content-Type":"application/json",
    "Authorization":"Bearer " + session.access_token
  };

  const res = await fetch(API_BASE + path, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null
  });

  if (!res.ok){
    const txt = await res.text();
    throw new Error(`API ${res.status}: ${txt}`);
  }

  return res.json();
}

/* ---- CARREGAR DADOS INICIAIS ---- */
async function carregarDadosIniciais(){
  const s = await supabaseClient.auth.getSession();
  session = s.data.session;
  user = session?.user ?? null;

  try { receitas = await apiFetch("receitas/"); } catch { receitas = []; }
  try { compras = await apiFetch("compras/"); } catch { compras = []; }

  atualizarDashboard();
  renderHistory();
}

/* ---- LANÇAMENTOS ---- */
async function adicionarReceita(){
  const descricao = document.getElementById("descricao-receita").value.trim();
  const valor = Number(document.getElementById("valor-receita").value);

  if (!descricao || !valor) return alert("Campos inválidos");

  const res = await apiFetch("add-receita/","POST",{descricao,valor});
  receitas.unshift(res.data || res);

  document.getElementById("descricao-receita").value = "";
  document.getElementById("valor-receita").value = "";

  atualizarDashboard();
  renderHistory();
}

async function adicionarCompra(){
  const descricao = document.getElementById("descricao-compra").value.trim();
  const valor = Number(document.getElementById("valor-compra").value);

  if (!descricao || !valor) return alert("Campos inválidos");

  const res = await apiFetch("add-compra/","POST",{descricao,valor});
  compras.unshift(res.data || res);

  document.getElementById("descricao-compra").value = "";
  document.getElementById("valor-compra").value = "";

  atualizarDashboard();
  renderHistory();
}

/* ---- DASHBOARD ---- */
function atualizarDashboard(){
  const sumR = receitas.reduce((t,i)=>t+Number(i.valor||0),0);
  const sumC = compras.reduce((t,i)=>t+Number(i.valor||0),0);

  document.getElementById("total-receitas-display").innerText =
    sumR.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  document.getElementById("total-compras-display").innerText =
    sumC.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  const restante = 81000 - sumR;
  document.getElementById("resumo-rapido").innerText =
    `Receitas: R$ ${sumR} • Compras: R$ ${sumC} • Limite restante: R$ ${restante}`;
}

/* ---- HISTÓRICO ---- */
function renderHistory(){
  const filtro = document.getElementById("filtro-tipo").value;
  const list = document.getElementById("history-list");
  list.innerHTML = "";

  let items = [];

  if (filtro==="all" || filtro==="receitas"){
    receitas.forEach(r => items.push({type:"receita",...r}));
  }
  if (filtro==="all" || filtro==="compras"){
    compras.forEach(c => items.push({type:"compra",...c}));
  }

  if (items.length===0){
    list.innerHTML = "<div class='row'><div>Nenhum lançamento.</div></div>";
    return;
  }

  items.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));

  items.forEach(it => {
    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");
    left.innerHTML = `
      <strong>${it.type==="receita"?"Receita":"Compra"}</strong>
      <div>${escapeHtml(it.descricao)}</div>
    `;

    const right = document.createElement("div");
    right.innerHTML = `
      <div style="text-align:right">
        ${Number(it.valor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
      </div>
    `;

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });
}

document.getElementById("filtro-tipo").addEventListener("change", renderHistory);

/* ---- NAVEGAÇÃO ---- */
function showPage(page){
  const pages = ["dashboard","lancamentos","historico","cnpj","acoes"];
  pages.forEach(p => {
    const el = document.getElementById(p);
    if (el) el.style.display = p===page ? "block" : "none";
  });

  document
    .querySelectorAll(".sidebar .btn")
    .forEach(b => b.classList.toggle("active", b.dataset.target===page));
}

/* ---- Início padrão ---- */
showOnlyLogin();
</script>
</body>
</html>


