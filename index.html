<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor MEI - SaaS</title>

    <!-- CSS LIMPO + SIMPLES (OPÃ‡ÃƒO B) -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #007bff;
            padding: 20px;
            color: white;
            text-align: center;
        }

        h1, h2 { margin: 0 0 15px; }

        #container {
            max-width: 800px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 18px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover { background-color: #0056b3; }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }

        .item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .empty {
            color: #777;
            font-style: italic;
        }
    </style>
</head>
<body>

<header>
    <h1>Gestor MEI</h1>
</header>

<div id="container">

    <!-- ÃREA DE LOGIN -->
    <section id="login-section">
        <h2>Entrar</h2>
        <p>Use sua conta Google para continuar.</p>
        <button id="google-login-btn">Entrar com Google</button>
    </section>

    <!-- ÃREA PRINCIPAL -->
    <section id="app-section" style="display:none;">
        <h2>Dashboard</h2>
        <p><strong>Total Recebido:</strong> R$ <span id="total-receitas">0,00</span></p>
        <p><strong>Total Comprado:</strong> R$ <span id="total-compras">0,00</span></p>

        <hr>

        <h2>LanÃ§ar Receita</h2>
        <input id="desc-receita" placeholder="DescriÃ§Ã£o">
        <input id="valor-receita" type="number" placeholder="Valor">
        <button onclick="adicionarReceita()">Adicionar Receita</button>

        <h2>LanÃ§ar Compra</h2>
        <input id="desc-compra" placeholder="DescriÃ§Ã£o">
        <input id="valor-compra" type="number" placeholder="Valor">
        <button onclick="adicionarCompra()">Adicionar Compra</button>

        <hr>

        <h2>HistÃ³rico</h2>
        <div id="lista-historico" class="empty">Nenhum lanÃ§amento ainda.</div>
    </section>
</div>

<!-- SCRIPT SUPABASE + BACKEND DJANGO -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// CONFIG SUPABASE
const SUPABASE_URL = "https://zrpxtooampraytmkywhl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // SUA CHAVE AQUI
const API_BASE = "https://gestor-mei-backend.onrender.com/api/";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let usuario = null;

// LOGIN GOOGLE
const loginBtn = document.getElementById("google-login-btn");
loginBtn.addEventListener("click", async () => {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: window.location.href }
    });
});

// VERIFICA SESSÃƒO
supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
        usuario = session.user;
        document.getElementById("login-section").style.display = "none";
        document.getElementById("app-section").style.display = "block";
        carregarDados();
    }
});

// FUNÃ‡Ã•ES API
async function carregarDados() {
    const receitas = await fetch(API_BASE + "receitas/" + usuario.id).then(r=>r.json());
    const compras = await fetch(API_BASE + "compras/" + usuario.id).then(r=>r.json());

    let totalReceitas = 0, totalCompras = 0;
    let html = "";

    receitas.forEach(r=>{
        totalReceitas += Number(r.valor);
        html += `<div class='item'>ðŸŸ¦ Receita: ${r.descricao} â€” R$ ${r.valor}</div>`;
    });

    compras.forEach(c=>{
        totalCompras += Number(c.valor);
        html += `<div class='item'>ðŸŸ¥ Compra: ${c.descricao} â€” R$ ${c.valor}</div>`;
    });

    document.getElementById("lista-historico").innerHTML = html || "<p class='empty'>Nenhum lanÃ§amento.</p>";
    document.getElementById("total-receitas").innerText = totalReceitas.toFixed(2);
    document.getElementById("total-compras").innerText = totalCompras.toFixed(2);
}

async function adicionarReceita() {
    const desc = document.getElementById("desc-receita").value;
    const valor = document.getElementById("valor-receita").value;
    
    await fetch(API_BASE + "add-receita/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: usuario.id, descricao: desc, valor })
    });

    carregarDados();
}

async function adicionarCompra() {
    const desc = document.getElementById("desc-compra").value;
    const valor = document.getElementById("valor-compra").value;
    
    await fetch(API_BASE + "add-compra/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: usuario.id, descricao: desc, valor })
    });

    carregarDados();
}
</script>
</body>
</html>
